define(["template","dialog","constant","report/edit/canvas/edit-comp-model","report/edit/canvas/comp-setting-default-template","report/edit/canvas/comp-setting-time-template","report/edit/canvas/comp-setting-liteolap-template","report/edit/canvas/default-selected-time-setting-template","report/edit/canvas/data-format-setting-template","common/float-window","report/edit/canvas/chart-icon-list-template"],function(a,b,c,d,e,f,g,h,i,j,k){return Backbone.View.extend({events:{"click .j-comp-setting .j-delete":"deleteCompAxis","click .j-report":"removeCompEditBar","click .j-set-default-time":"openTimeSettingDialog","click .j-set-data-format":"getDataFormatList","click .item .j-icon-chart":"showChartList"},initialize:function(a){this.model=new d({canvasModel:a.canvasView.model,reportId:a.reportId}),this.canvasView=a.canvasView,this.$conCompSetting=this.$el.find(".j-con-comp-setting")},initCompConfigBar:function(a){var b=this,c=$(a.target),d=c.parents(".j-component-item"),e=d.attr("data-comp-id"),f=d.attr("data-component-type");b.model.compId=e,b.model.compType=f,b.hideEditBar(),b.model.getCompAxis(e,function(a){a.compId=e;var c=b._adapterEditCompTemplate(f);a.compType=f;var g=c.render(a);a.compId=e,b.$el.find(".j-con-comp-setting").html(g),b.initLineAccept(f),d.addClass("active").mouseout(),b.initSortingItem(),b.canvasView.parentView.ueView.setSize()})},_adapterEditCompTemplate:function(a){var b;switch(a){case"TIME_COMP":b=f;break;case"LITEOLAP":b=g;break;default:b=e}return b},initLineAccept:function(a){var b,c=this,d=".j-olap-element",e=".j-time-dim";switch(a){case"TIME_COMP":b=e;break;case"LITEOLAP":b=d;break;default:b=d}$(".j-comp-setting-line",this.el).droppable({accept:b,drop:function(b,d){var e=$(this);c.addCompAxis(d,e,a),e.removeClass("active")},out:function(){$(this).removeClass("active")},over:function(){$(this).addClass("active")},helper:"clone"})},initSortingItem:function(){var a=this,b={};$(".j-line-x,.j-line-y",this.el).sortable({items:".j-root-line,.j-cal-ind,.j-group-title",axis:"x",start:function(a,c){c.placeholder.height(0),b.source=c.item.parent().find("[data-id]").index(c.item)},stop:function(c,d){var e=d.item.parent(),f=e.parent().attr("data-comp-id");b.target=e.find("[data-id]").index(d.item),b.type=e.attr("data-axis-type"),b.source!=b.target&&a.model.sortingCompDataItem(f,b,function(){a.canvasView.showReport()})}})},deleteCompAxis:function(a){var b,c,d=this,e=$(a.target);b=".j-comp-setting";var f=e.parents(b),g=f.attr("data-comp-id"),h=f.attr("data-comp-type");b=".j-comp-setting-line",c="data-axis-type";var i=e.parents(b).attr(c);c="data-id";var j=e.parent().attr(c);d.model.deleteCompAxis(g,i,j,function(){var a=e.parent(),b=a.attr("data-id");if(e.parent().remove(),d.afterDeleteCompAxis({oLapElementId:b,compType:h,axisType:i,$item:e.parent()}),d.canvasView.showReport(),0==d.$el.find("[data-id="+b+"]").length){var c=" .j-root-line[data-id="+b+"]";$(".j-con-org-ind"+c).addClass("j-can-to-dim"),$(".j-con-org-dim"+c).addClass("j-can-to-ind")}})},afterDeleteCompAxis:function(a){if(void 0!==a.compType){var b=this._switchCompTypeWord(a.compType);this["afterDelete"+b+"CompAxis"](a)}},afterDeleteLiteOlapCompAxis:function(a){var b=this,c=b.$el.find(".j-comp-setting"),d=a.axisType;"xys".indexOf(d)>-1;var e="[data-id="+a.oLapElementId+"]",f=c.find(e);e=".j-delete";var g='<span class="icon-letter j-delete">×</span>';1==f.length&&0==f.find(e).length&&f.append(g)},afterDeleteTimeCompAxis:function(a){for(var b=this.model.canvasModel.compBoxModel,c=b.getComponentData("TIME_COMP"),d=this.getActiveCompId(),e=this.canvasView.editCompView.model,f=e.getCompDataById(d)[0],g=a.$item.attr("data-name"),h=c.switchLetter(g),i=f.dataSetOpt.timeTypeList,j=0,k=i.length;k>j;j++)if(h==i[j].value){i.splice(j,1);break}delete f.dataSetOpt.timeTypeOpt[h],delete f.dateKey[h],f.name=f.dateKey[f.dataSetOpt.timeTypeList[0].value],this.model.canvasModel.saveReport()},addCompAxis:function(a,b){var c,d,e,f,g=a.helper,h=this;c=".j-comp-setting";var i=b.parents(c),j=i.attr("data-comp-id"),k=i.attr("data-comp-type"),l=g.clone().attr("style",""),m=l.find("span");l.hasClass("j-group-title")?l.addClass("item"):m.eq(1).remove(),a.draggable.removeClass("j-can-to-dim j-can-to-ind"),c=".j-data-sources-setting-con-ind",f=a.draggable.parents(c),f=f.length?"ind":"dim";var d;"ind"===f&&"TABLE"!==k&&(d='<span class="icon-chart bar j-icon-chart" chart-type="bar" ></span>',l.prepend(d)),d='<span class="icon hide j-delete" title="删除">×</span>',l.append(d),$(l.find(".j-item-text")).removeClass("ellipsis").addClass("icon-font"),e=h.canvasView.parentView.model.get("currentCubeId");var n={cubeId:e,oLapElementId:l.attr("data-id"),axisType:b.attr("data-axis-type")};l.removeClass("j-olap-element").addClass("c-m"),h.model.addCompAxis(j,n,function(){l.removeClass("j-time-dim"),b.append(l),h.afterAddCompAxis({compType:k,oLapElemenType:f,oLapElementId:n.oLapElementId,axisType:n.axisType,$item:l}),h.canvasView.showReport(),h.canvasView.parentView.ueView.setSize()})},showChartList:function(a){var b=this,d=$(a.target),e=".j-comp-setting",f=d.parents(e),g=f.attr("data-comp-id"),h=d.parent().attr("data-id"),i=d.attr("chart-type"),l=c.CHART_TYPES;for(var m in l)l[m]=!1;l[i]=!0,b.chartList?b.chartList.redraw(k.render(l)):b.chartList=new j({direction:"vertical",content:k.render(l)}),$(".comp-setting-charticons span").unbind(),$(".comp-setting-charticons span").click(function(){var a=$(this),c=a.attr("chart-type");b.model.changeCompItemChartType(g,h,c,function(){d.removeClass(i).addClass(c),d.attr("chart-type",c),b.chartList.hide(),b.canvasView.showReport()})}),b.chartList.show($(a.target).parent())},afterAddCompAxis:function(a){if(void 0!==a.compType){var b=this._switchCompTypeWord(a.compType);this["afterAdd"+b+"CompAxis"](a)}},afterAddLiteOlapCompAxis:function(a){function b(){var b=a.oLapElementId,c="[data-id="+b+"]",e=d.find(c);if(1==e.length){c="ind"==a.oLapElemenType?".j-line-cand-ind":".j-line-cand-dim";var f=a.$item.clone();f.find(".j-delete").remove(),d.find(c).append(f)}else if(2==e.length){var g=e.eq(1).find(".j-delete");1==g.length&&g.remove()}}var c=this,d=c.$el.find(".j-comp-setting"),e="xys".indexOf(a.axisType)>-1;e&&b()},afterAddTimeCompAxis:function(a){var b,c,d=this.model.canvasModel.compBoxModel,e=d.getComponentData("TIME_COMP"),f=this.getActiveCompId(),g=this.canvasView.editCompView.model,h=g.getCompDataById(f)[0],i=a.$item.attr("data-name"),j=a.$item.attr("data-id"),k=e.config,l=e.switchLetter(i);b=k.timeTypeListConfig[l],c=k.timeTypeOptConfig[l],h.dataSetOpt.timeTypeList.push(b),h.dataSetOpt.timeTypeOpt[l]=c,h.dateKey[l]=j,h.name=h.dateKey[h.dataSetOpt.timeTypeList[0].value],this.model.canvasModel.saveJsonVm(),this.model.canvasModel.saveReport()},_switchCompTypeWord:function(a){var b;switch(a){case"LITEOLAP":b="LiteOlap";break;case"TIME_COMP":b="Time"}return b},_getEditBarAndActiveComp:function(){var a,b,c=this.$el.find(".j-comp-setting"),d={};return 0===c.length?d:(d.$compSetting=c,a=c.attr("data-comp-id"),b=".j-component-item[data-comp-id="+a+"]",d.$activeComp=this.$el.find(b),d)},hideEditBar:function(){var a=this._getEditBarAndActiveComp();void 0!==a.$compSetting&&a.$compSetting.remove(),void 0!==a.$activeComp&&a.$activeComp.removeClass("active"),this.canvasView.parentView.ueView.setSize()},activeComp:function(){var a=this._getEditBarAndActiveComp();void 0!==a.$activeComp&&a.$activeComp.addClass("active")},removeCompEditBar:function(a){var b=this;$(a.target).parent().hasClass("j-report")&&b.hideEditBar()},openTimeSettingDialog:function(){function a(a){var b=[],c=a.find(".j-item");return c.each(function(){var a={},c=$(this),d=c.attr("data-type"),e=c.find("select").val(),f=c.find("input").val();a.type=d,a.date=[f+e],b.push(a)}),b}var c=this,d=c.model.canvasModel.compBoxModel,e=c.getActiveCompId(),f=c.model.getCompDataById(e),g=d.getComponentData("TIME_COMP").deSwitchConfig,i=g(f[0].dataSetOpt.timeTypeOpt),j=h.render({list:i});b.showDialog({title:"默认选中时间设置",content:j,dialog:{width:300,height:249,open:function(){},buttons:[{text:"提交",click:function(){var b=$(this),d=a(b);c.model.updateCalendarJson(d,function(){b.dialog("close"),c.canvasView.showReport()})}},{text:"取消",click:function(){$(this).dialog("close")}}]}})},getDataFormatList:function(){function a(a){var d;return a?(d=i.render(a),b.showDialog({title:"数据格式",content:d,dialog:{width:340,height:400,resizable:!1,buttons:[{text:"提交",click:function(){c($(this))}},{text:"取消",click:function(){$(this).dialog("close")}}]}}),void 0):(b.alert("没有指标"),void 0)}function c(a){var b=$(".data-format").find("select"),c={};b.each(function(){var a=$(this),b=a.attr("name");c[b]=a.val()}),d.model.saveDataFormatInfo(e,c,function(){a.dialog("close"),d.canvasView.showReport()})}var d=this,e=d.getActiveCompId();d.model.getDataFormatList(e,a)},getActiveCompId:function(){var a=this.$conCompSetting.find(".j-comp-setting");return a.attr("data-comp-id")}})});